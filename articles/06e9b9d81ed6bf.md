---
title: "[Next.js]firestoreã§getServerSidePropsã‚’ä½¿ã£ãŸæ™‚ã®ç„¡é™ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "firebase", "firestore"]
published: true
---

â€»ã“ã®æ–¹æ³•ã¯ç„¡é™ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«ã—ã‹ä½¿ãˆã¾ã›ã‚“ã€‚
é€šå¸¸ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ firestore ã§è¡Œã†å ´åˆã¯ id ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªé€£ç•ªã«ã™ã‚‹ãªã©ã®å·¥å¤«ãŒå¿…è¦ãªã‚ˆã†ã§ã™ã€‚

å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã¯[å®Ÿè£…ä¾‹](#å®Ÿè£…ä¾‹)ã«ã‚ã‚Šã¾ã™ã€‚

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

firestore ã§ç„¡é™ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ãŸãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã€‚
getServerSideProps å´ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã™ã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ãã®åˆ†ã‚’å·®ã—å¼•ã„ãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ãŸã‹ã£ãŸãŒã€ãã®æ–¹æ³•ã«ã¤ã„ã¦è¨˜è¿°ã™ã‚‹è‰¯ã„ã‚µãƒ³ãƒ—ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãšã€è‡ªåˆ†ãªã‚Šã«å®Ÿè£…ã—ã¦ã¿ãŸã€‚

firestore ã¯`v9`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚
firestore ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚„ã‚Šã«ãã„ã¨ã„ã†èªè­˜ãŒã‚ã‚‹ã€‚
SQL ã¨é•ã£ã¦ `limit` ã®ã¿ã§å®Ÿè£…ãŒå‡ºæ¥ãªã„ã‹ã‚‰ã ã€‚
`offSet()`ã‚‚ã‚ã‚‹ãŒã€ã‚ªãƒ•ã‚»ãƒƒãƒˆã§å–å¾—ã™ã‚‹å ´åˆã€ã‚ªãƒ•ã‚»ãƒƒãƒˆæŒ‡å®šã‚ˆã‚Šå‰ã®ãƒ‡ãƒ¼ã‚¿åˆ†ã‚‚èª²é‡‘å¯¾è±¡ã¨ãªã‚‹ã€‚

### SQL ã®å ´åˆ

SQL ã«æ…£ã‚Œã¦ã„ã‚‹ã¨ä¾‹ãˆã°æ›´æ–°æ—¥æ™‚ã‚’é™é †ã§ä¸¦ã³æ›¿ãˆã¦ãã® 20 ç•ªç›®ã‹ã‚‰å–å¾—ã™ã‚‹ã€ã¨ã„ã£ãŸäº‹ãŒå¯èƒ½ã ã‹ã‚‰ã“ã‚Œã‚’ä½¿ã£ã¦ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```sql
  -- idã‚’é™é †ã§ä¸¦ã³æ›¿ãˆãŸãƒ‡ãƒ¼ã‚¿ã®11ç•ªç›®ã‹ã‚‰æœ€å¤§10ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  SELECT id, name FROM 'hoge' ORDER BY id DESC LIMIT 11, 10;
```

### Firestore ã®å ´åˆ

firestore ã§ã¯ä»£ã‚ã‚Šã«`startAt()`ã‚‚ã—ãã¯`startAfter()`ã¨ã„ã†ã‚¯ã‚¨ãƒªã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½¿ç”¨ã—ã¦é–‹å§‹åœ°ç‚¹ã‚’è¨­å®šã•ã›ã‚‹ã€‚

```ts
const ref = collection(DB, "posts");
// idã‚’é™é †ã§ä¸¦ã³æ›¿ãˆã¦ã€æœ€å¾Œã®ãƒ‡ãƒ¼ã‚¿ã®idã‚’æ ¼ç´
const q = query(ref, orderBy("id", "desc"), startAfter(lastId), limit(10));
```

ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€`startAfter()`ã«å…¥ã‚ŒãŸ id ã‚ˆã‚Šæ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å¤§ 10 ä»¶å–å¾—ã—ã¦ã„ã‚‹ã€‚

ã¡ãªã¿ã«ã€query ã«å…¥ã‚Œã‚‹`QueryConstraint`ã¯é…åˆ—ãªã®ã§ã€ã“ã‚“ãªäº‹ã‚‚ã§ãã‚‹æ¨¡æ§˜ã€‚å€‹äººçš„ã«ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ãŒã‚ˆããªã‚‹ã®ã§å¥½ã‚“ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚

```ts
// é…åˆ—ã«æ ¼ç´ã—ã¦ã€
const querys = [
  orderBy("updatedAt", "desc"),
  startAfter(lastUpdatedAt),
  limit(10),
];
// å±•é–‹ã—ã¦ä½¿ç”¨ã™ã‚‹
const qeryRef = query(ref, ...querys);
```

#### ãã‚Œãã‚Œã®é•ã„

`startAt()`ã¯ç‰¹å®šã®å€¤ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã€‚
`startAfter()`ã¯ç‰¹å®šã®å€¤ã‚ˆã‚Šæ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã€‚

ã‚¯ã‚¨ãƒªã‚«ãƒ¼ã‚½ãƒ«ã§ã¯ä¸¦ã³æ›¿ãˆãŸé †ç•ªã§æŒ‡å®šãŒã§ããªã„ã€‚
ã‚ãã¾ã§ã€`orderBy()`ã§ä¸¦ã³æ›¿ãˆãŸå€¤ã®ç‰¹å®šå€¤ã‚ˆã‚Šä¸Šã‹ä¸‹ã€ã®ã‚ˆã†ãªå½¢ã«ãªã‚‹ã€‚

## å®Ÿè£…ä¾‹

ã“ã®ã‚¯ã‚¨ãƒªã‚«ãƒ¼ã‚½ãƒ«ã®ç‰¹æ€§ã‚’è¸ã¾ãˆã¦`getServerSideProps`ã‚’è·¨ã„ã å ´åˆã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã¿ãŸã€‚
ã‚µãƒ¼ãƒãƒ¼å´ã§ 10 ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«å–å¾—ã•ã›ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«æ¸¡ã—ã¦ã„ã‚‹ã€‚

```ts
// ã‚µãƒ¼ãƒãƒ¼å´
export const getServerSideProps: GetServerSideProps = async (context) => {

  try {
    const ref = collection(DB, 'posts')
    const results = await getDocs(
      query(
        ref,
        orderBy('updatedAt', 'desc'),
        limit(10)
      )
  } catch(error) {
    return {
      props: {
        error: error
      }
    }
  }
  return {
    props: {
      defaultPosts: posts
    }
  }
}
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ¬¡ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã™ã‚‹å ´åˆã€10 ä»¶ã‚’å«ã¾ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã»ã—ã„ã€‚
ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ç‚ºã«æ±ç”¨æ€§ã®é«˜ã„æ—¥ä»˜ã‚’ãƒŸãƒªç§’ã® Timestamp ã‚’ä½¿ç”¨ã—ã¦è§£æ±ºã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

```ts
const ref = useRef(null);
const pageSize = 10;
const [posts, setPosts] = useState([...defaultPosts]);
const [isLoading, setIsLoading] = useState(false);

// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘æ¸¡ã•ã‚ŒãŸ10ä»¶ã‚ˆã‚Šä¸‹å›ã‚‹å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
const [isCompleted, setIsCompleted] = useState(pageSize > defaultPosts.length);
// intersection observerã‚’ä½¿ã£ã¦ãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚‹ã‚¿ã‚°ã‚’ç›£è¦–ã—ã¦ã„ã‚‹
const isBottomVisible = useIntersectionObserver(ref, { threshold: 0 }, false);
// æœ€å¾Œã®ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°æ—¥æ™‚ï¼ˆãƒŸãƒªç§’ã®numberï¼‰
const lastUpdatedAt = posts[posts.length - 1].updatedAt;

useEffect(() => {
  if (!isCompleted && !isLoading && isBottomVisible) {
    setIsLoading(true);

    // APIèª­è¾¼
    const colRef = collection(DB, collectionPath);
    const querys = [
      // order by ã§æ›´æ–°æ—¥æ™‚ã‚’é™é †ã§æŒ‡å®šã—
      orderBy("updatedAt", "desc"),
      // start after ã§æœ€å¾Œã®ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°æ—¥æ™‚ã‚’æŒ‡å®š
      startAfter(lastUpdatedAt),
      // æœ€å¤§10ä»¶ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
      limit(pageSize),
    ];
    const qeryRef = query(colRef, ...querys);

    (async () => {
      try {
        const result = await getDocs(qeryRef);
        const copy = [...posts];
        result.docs.map((snap) => {
          const data = snap.data();
          copy.push({
            id: snap.id,
            ...data,
          });
        });
        setPosts(copy);

        // å–å¾—ãƒ‡ãƒ¼ã‚¿ãŒæŒ‡å®šæœ€å¤§æ•°ã‚’ä¸‹å›ã£ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
        const completed = result.docs.length < pageSize;
        setIsCompleted(completed);

        setIsLoading(false);
      } catch (error) {
        console.error(error);
        setIsLoading(false);
      }
    })();
  }
}, [isBottomVisible]);
```

### æ³¨æ„ç‚¹

firestore ã®ä»•æ§˜ä¸Šã€`orderBy()` ã§æŒ‡å®šã—ã¦ãªã„ã‚«ãƒ©ãƒ ã‚’ `startAfter()` ã§æŒ‡å®šã§ããªã„ã€‚
`startAt()`ã®å ´åˆã‚‚åŒæ§˜ã€‚

ãƒŸãƒªç§’ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã¯ã„ãˆã€è¢«ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§å®Œå…¨ãªãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€`startAfter()`ã‚’ä½¿ç”¨ã™ã‚‹ã¨åŒã˜å€¤ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã¨è¡¨ç¤ºã•ã‚Œãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ›´æ–°é »åº¦ãŒé«˜ã„ã‚¢ãƒ—ãƒªã ã¨å³ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
