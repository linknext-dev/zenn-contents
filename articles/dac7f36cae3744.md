---
title: "[Next.js]firestoreã‚’ä½¿ã£ã¦ã„ã„ã­æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "firestore"]
published: false
---

Next.js ã¨ firestore ã§ç°¡æ˜“ãªã„ã„ã­æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã®ã§ãã®æ™‚ã®ãƒ¡ãƒ¢ã€‚
ã‚«ã‚¦ãƒ³ãƒˆãªã©ã®æ­£ç¢ºæ€§ã‚ˆã‚Šã‚‚ã‚³ã‚¹ãƒˆé¢ã¨å®Ÿè£…é¢ã‚’é‡è¦–ã—ã¦ã„ã‚‹ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚

## ã“ã®ã„ã„ã­æ©Ÿèƒ½ã§å‡ºæ¥ãªã„ã“ã¨

- èª°ãŒèª°ã®ã„ã„ã­ã‚’ã—ãŸã‹ã‚’è¾¿ã‚‹ã“ã¨ã€‚
- ã„ã„ã­ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã„ã„ã­å…¨ä½“ã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã€‚

ã©ã¡ã‚‰ã‚‚è¿½åŠ å®Ÿè£…ã§å¯èƒ½ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ãã®å ´åˆã¯ç´ ç›´ã«ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ id ã¨ã„ã„ã­ã—ãŸè¨˜äº‹ id ã‚’ 1 ã¤ãšã¤æ ¼ç´ã™ã‚‹ã‚¿ã‚¤ãƒ—ã«åˆ‡ã‚Šæ›¿ãˆãŸã»ã†ãŒã„ã„ã¨æ€ã‚ã‚Œã‚‹ã€‚

### ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­è¨ˆ

è¨˜äº‹ã‚’æ ¼ç´ã—ã¦ã„ã‚‹`posts`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¯åˆ¥ã«ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³`likes`ã‚’ä½œæˆã€‚
`likes`ç›´ä¸‹ã«ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒãŸã›ã‚‹ã€‚

#### likes

```ts
type LikesType = {
  likedUsers: string[];
};
```

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ id ã¯è¨˜äº‹ id ã¨å…±é€šåŒ–ã™ã‚‹ã€‚
`likedUsers`ã¯ã„ã„ã­ã‚’ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ id ã‚’æ ¼ç´ã™ã‚‹ã€‚
ã„ã„ã­ã®æ•°ã¯`likedUsers.length`ã§å–å¾—ã™ã‚‹ã€‚

#### posts

```ts
type PostsType = {
  ...
  title: string
  body: string
  likes: LikesType  // ã“ã“
  ...
}
```

è¨˜äº‹ã‚’æ ¼ç´ã—ã¦ã„ã‚‹`posts`ã« `likes` ã‚’æ ¼ç´ã§ãã‚‹å ´æ‰€ã‚’ä½œã£ã¦ãŠãã€‚

## ä»•çµ„ã¿

ã„ã„ã­ã•ã‚Œã‚‹ã¨é…åˆ—ã« uid ã‚’æ ¼ç´ã—ã€`likes`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²ã€‚
ç™»éŒ²ã™ã‚‹ã¨ functions å´ã§ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ãŒç™ºå‹•ã—ã€`posts`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã€‚

### functions ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°

`likes`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã® write ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸæ™‚ã«ç™ºå‹•ã™ã‚‹ã€‚
`posts`ã¨å…±é€š id ãªã®ã§ã€snapshot ã‹ã‚‰ id ã‚’å–å¾—ã§ãã‚‹ã€‚
ç´ ç›´ã«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆã« postId ã‚’å«ã‚ã¦ã‚‚è‰¯ã„ã¨æ€ã†ã€‚

`setDocument()`ã¯å½“è©²`posts`ã®ãƒ‡ãƒ¼ã‚¿ã« firestore ã®`setDoc()`é–¢æ•°ã«ã¦`{merge:true}`ã§ä¸Šæ›¸ãã—ã€likes ã ã‘ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ã‚‹ã€‚

```ts
const Ref = functions.firestore.document("likes/{likeID}");

export const onUpdate = Ref.onUpdate(async (change, context) => {
  const likes = snap.data();
  const setData = {
    likes: likes,
  };
  await setDocument(db, setData, "posts", change.after.id);
});
```

### firestore rules

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Rules ã§æ¸ˆã¾ã›ã¦ã„ã‚‹ã€‚
ã‚µã‚¤ã‚ºã®ç¢ºèªã€key ãŒå…¨ã¦å­˜åœ¨ã—ã€likedUsers ãŒé…åˆ—ã€‚
æ›´æ–°ã®å ´åˆã¯å‰å›ã®ã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚ˆã‚Š 1 ã®ã¿å¤šã„ã€ã‹ã¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ããŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã® id ãŒ likedUsers ã«å«ã‚“ã§ã„ã‚‹ã€‚
ã¾ãŸã¯ã€å‰å›ã®ã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚ˆã‚Š 1 ã®ã¿å°‘ãªã„å ´åˆã‚’è¨±å¯æ¡ä»¶ã¨ã—ãŸã€‚

ä½œæˆã®å ´åˆã¯ã‚«ã‚¦ãƒ³ãƒˆæ•°ãŒ 1 ã§ã‚ã‚‹äº‹ã€
æ›´æ–°æ™‚ã¨åŒã˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ããŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã® id ãŒ likedUsers ã«å«ã‚“ã§ã„ã‚‹äº‹ã‚’è¨±å¯æ¡ä»¶ã¨ã—ã¦ã„ã‚‹ã€‚

```js
match /likes/{likeID} {
  function requestUserId() {
    return request.auth.uid;
  }
  function getLikes(likeID) {
    return get(/databases/$(database)/documents/likes/$(likeID)).data
  }
  function hasLikes(likeID) {
    return exists(/databases/$(database)/documents/likes/$(likeID))
  }
  function isValidLikesData(data, likeID) {
    let dataKeys = data.keys();
    let beforeCount = getLikes(likeID).likedUsers.size();
    let count = data.likedUsers.size();
    return dataKeys.size() == 1 &&
      ['likedUsers'].hasAll(dataKeys) &&
      data.likedUsers is list &&
      (
        (
          hasLikes(likeID) &&
          (
            (
              beforeCount + 1) == count &&
              data.likedUsers.hasAny([requestUserId()]
            ) ||
            (beforeCount - 1) == count
          )
        ) ||
        (
          count == 1 &&
          data.likedUsers.hasAny([requestUserId()])
        )
      );
  }
  allow read;
  allow write: if isAuthenticated() &&
    isValidLikesData(incomingData(), likeID);
}
```

## ãƒ•ãƒ­ãƒ³ãƒˆé¢ã®å®Ÿè£…

`posts`ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å«ã¾ã‚Œã‚‹`likes`ã‹ã‚‰ã€ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ id ã‚’æ ¼ç´ã™ã‚‹é…åˆ—ã‚’èª­ã¿è¾¼ã‚€ã€‚
ãã—ã¦ãã®æ•°ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

å•é¡Œã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã„ã­ã—ã¦ã„ã‚‹æ™‚ã¨ãã†ã§ãªã„æ™‚ã§è¨ˆç®—ãŒç•°ãªã‚‹ã“ã¨ã€‚
æ—¢ã«é–²è¦§è€…ãŒã„ã„ã­ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã„ã„ã­ãƒœã‚¿ãƒ³ã‚’ã„ã„ã­æ¸ˆã¿ã«å¤‰æ›´ã—ã€ã¾ãŸæŠ¼ã—ãŸæ™‚ã®å‡¦ç†ã‚‚å¤‰æ›´ãŒå¿…è¦ã€‚

```ts
let result = 0;
const count = likes.likedUsers.length;

// å‰å›ã„ã„ã­ã—ã¦ã„ãŸã‹
if (beforeIsLiked) {
  result = isLiked ? count : count - 1;
} else {
  result = isLiked ? count + 1 : count;
}
```

ä¸Šè¨˜ã®ã‚ˆã†ãªå½¢ã§è¨ˆç®—ã™ã‚‹ã€‚

```tsx
const [isLiked, setIsLiked] = useState<boolean>(beforeIsLiked);
return isLiked ? <Liked /> : <NotLiked />;
```

ãƒœã‚¿ãƒ³ã¯ `isLiked`ã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã€ãã‚Œã«æ²¿ã£ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´ã™ã‚‹ã®ã¿ã€‚

## å•é¡Œç‚¹ã¨æ³¨æ„ç‚¹

### user id æ¤œè¨¼

user id ã®æ¤œè¨¼ã¯ deliked ãªå ´åˆã¯ä¸å¯èƒ½ãªç‚ºã€å•é¡ŒãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
ã“ã®å•é¡Œã‚’è§£æ±ºã—ãŸã„å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® id ã‚’å«ã‚€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ï¼ˆ`/users/$(userID)/likes/$(likeID)`ã®ã‚ˆã†ãªæ„Ÿã˜ï¼‰ã§è¡Œãˆã°è‰¯ã„ã€‚
ã“ã†ã™ã‚‹äº‹ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª°ã«ã„ã„ã­ã—ãŸã®ã‹ã€ã¨ã„ã†æ©Ÿèƒ½ã‚‚è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

ãŸã ã€ã“ã®å ´åˆ public ã§ã¯ãªããªã‚‹ã®ã§ã€åˆ¥é€” public ç”¨ã‚³ãƒ”ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹å¿…è¦æ€§ãŒå‡ºã‚‹ã€‚
å®Ÿè£…ã‚³ã‚¹ãƒˆã‚’ã©ã“ã¾ã§è¨±å®¹ã™ã‚‹ã‹ã«ã‚ˆã£ã¦åˆ¤æ–­ã‚’å¤‰æ›´ã™ã‚‹äº‹ã‚‚å¯èƒ½ã ã¨æ€ã†ã€‚

### æ›´æ–°é »åº¦ã®å•é¡Œ

ã¾ãŸã€æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€åŒæ™‚ã«ã„ã„ã­ã•ã‚ŒãŸå ´åˆã« firestore ã® 1 ç§’ã« 1 å›ä»¥ä¸Šã®æ›´æ–°ãŒå‡ºæ¥ãªã„è¦å‰‡ã«å¼•ã£ã‹ã‹ã£ã¦å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã«ã¯[åˆ†æ•£ã‚«ã‚¦ãƒ³ã‚¿](https://firebase.google.com/docs/firestore/solutions/counters?hl=ja)ã¨å‘¼ã°ã‚Œã‚‹å®Ÿè£…ãŒå¿…è¦ã«ãªã‚‹ã€‚

ãŸã ã—ã€Firestore ã®åˆ†æ•£ã‚«ã‚¦ãƒ³ã‚¿ã«ã‚‚é™ç•ŒãŒã‚ã‚Šã€éå¸¸ã«è² è·ã®é«˜ã„çŠ¶æ…‹ã«é™¥ã£ãŸå ´åˆã«ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§ãŒä¿ã¦ãªã„ã‚‰ã—ã„ã€‚
Firestore ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¯æ•´åˆæ€§ã«é›£ãŒã‚ã‚‹`READ COMMITTED`ã§ã‚ã‚‹ã¨ã®ã“ã¨ã€‚
https://qiita.com/1amageek/items/2eff436fb69bea5875ea

ã¤ã¾ã‚Šã‚¢ãƒ—ãƒªã®äººæ°—ãŒä¸€å®šä»¥ä¸Šã«åˆ°é”ã™ã‚‹ã¨ã€å®Ÿè£…é¢ã§è£œãˆãªã„ã®ã§ firebase ã‹ã‚‰ç§»è¡Œã™ã‚‹é¸æŠè‚¢ãŒå…¥ã£ã¦ãã‚‹ã¨ã„ã†äº‹ãªã®ã ã‚ã†ã€‚
